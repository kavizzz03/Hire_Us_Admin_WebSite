<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jobs • Meals • Hires Manager</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
body{background:#0f172a;color:#e2e8f0;min-height:100vh;}
.card{background:#121a2b;color:#e2e8f0;}
</style>
</head>
<body>
<div class="container py-4">
<h3>Jobs & Meals Manager</h3>
<div class="row">
  <div class="col-md-4">
    <ul id="jobsList" class="list-group"></ul>
  </div>
  <div class="col-md-8">
    <h5 id="jobTitle">Select a job</h5>
    <p>Wants Meals: <span id="mealsYesCount">0</span></p>

    <button class="btn btn-success mb-2" onclick="addMeal()">Add Meal</button>

    <table class="table table-sm table-dark" id="mealsTable">
      <thead>
        <tr><th>#</th><th>Meal</th><th>Price</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <table class="table table-sm table-dark" id="hiresTable">
      <thead>
        <tr><th>#</th><th>ID Number</th><th>Worker</th><th>Hired At</th><th>Meals?</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
</div>

<script>
let currentJobId = null;

async function api(url,opt={}){ const r=await fetch(url,opt); return r.json(); }

async function loadJobs(){
  const data = await api('admin_jobs_meals.php?action=jobs');
  const ul = document.getElementById('jobsList'); ul.innerHTML='';
  if(data.ok && data.jobs.length>0){
    data.jobs.forEach(j=>{
      const li=document.createElement('li');
      li.className='list-group-item list-group-item-dark';
      li.textContent=j.job_title+' ('+j.location+')';
      li.onclick=()=>selectJob(j.id);
      ul.appendChild(li);
    });
  } else {
    ul.innerHTML='<li class="list-group-item">No jobs found</li>';
  }
}

async function selectJob(jobId){
  currentJobId=jobId;
  const data = await api('admin_jobs_meals.php?action=job_data&job_id='+jobId);
  if(!data.ok){ alert('Failed to load job data'); return; }

  document.getElementById('jobTitle').textContent=data.job.job_title;
  document.getElementById('mealsYesCount').textContent=data.wants_meals_count;

  // Meals
  const tbody=document.querySelector('#mealsTable tbody'); tbody.innerHTML='';
  data.meals.forEach((m,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${m.meal_name}</td><td>${m.meal_price}</td>
    <td>
      <button class="btn btn-sm btn-warning" onclick="updateMeal(${m.id})">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteMeal(${m.id})">Delete</button>
    </td>`;
    tbody.appendChild(tr);
  });

  // Hires
  const tbody2=document.querySelector('#hiresTable tbody'); tbody2.innerHTML='';
  data.hires.forEach((h,i)=>{
    const mealsBtn=`<button class="btn btn-sm ${h.wants_meals==='yes'?'btn-success':'btn-secondary'}"
      onclick="toggleMeals('${h.id_number}','${h.wants_meals}')">${h.wants_meals}</button>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${h.id_number}</td><td>${h.full_name}</td><td>${h.hired_at}</td><td>${mealsBtn}</td>`;
    tbody2.appendChild(tr);
  });
}

// Toggle wants meals
async function toggleMeals(id_number,current){
  const wants=current==='yes'?'no':'yes';
  await api('admin_jobs_meals.php?action=hire_toggle_meals',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`job_id=${currentJobId}&id_number=${encodeURIComponent(id_number)}&wants_meals=${wants}`
  });
  selectJob(currentJobId);
}

// Delete meal
async function deleteMeal(id){
  if(!confirm('Delete this meal?'))return;
  await api('admin_jobs_meals.php?action=meal_delete',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`id=${id}`
  });
  selectJob(currentJobId);
}

// Update meal
async function updateMeal(id){
  const name=prompt('Meal Name?'); if(!name)return;
  const desc=prompt('Description?',''); 
  const price=prompt('Price?','0');
  await api('admin_jobs_meals.php?action=meal_update',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`id=${id}&meal_name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}&meal_price=${encodeURIComponent(price)}`
  });
  selectJob(currentJobId);
}

// Add meal
async function addMeal(){
  if(!currentJobId){ alert('Select a job first'); return; }
  const name=prompt('Meal Name?'); if(!name)return;
  const desc=prompt('Description?',''); 
  const price=prompt('Price?','0');
  await api('admin_jobs_meals.php?action=meal_create',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`job_id=${currentJobId}&meal_name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}&meal_price=${encodeURIComponent(price)}`
  });
  selectJob(currentJobId);
}

loadJobs();
</script>
</body>
</html>
